name: CI
on: [push, pull_request]
jobs:
  Verification:
    name: ${{ matrix.config.name }}
    runs-on: ${{ matrix.config.os }}
    strategy:
      fail-fast: false
      matrix:
        config:
        - {
            name: "Linux",
            os: ubuntu-latest
          }
        - {
            name: "Windows",
            os: windows-latest
          }
    steps:
      - name: Clone the repo
        run: |
          BRANCH=${{ github.ref_name }}
          if [ ${{ github.event_name }} = 'pull_request' ]; then
            BRANCH=${{ github.head_ref }}
          fi
          echo "BRANCH:$BRANCH"
          git clone --depth 1 --single-branch --branch $BRANCH --no-tags https://github.com/${{ github.repository_owner }}/${{ github.event.repository.name }}.git
      - name: Install Doxygen
        run: |
          cd ${{ github.event.repository.name }}
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt install doxygen
            sudo apt install graphviz
          elif [ "$RUNNER_OS" == "Windows" ]; then
            choco install doxygen.install
            choco install graphviz
            echo "/C/Program Files/doxygen/bin" >> $GITHUB_PATH
          fi
      - name: Create the document
        run: |
          cd ${{ github.event.repository.name }}
          echo "$GITHUB_PATH"
          ls
          ls "/C/Program Files/doxygen/bin"
          doxygen -v
          pwd
          cmake -P cmake/Doxygen.cmake -v
#      - name: Check complexity
#        run: |
#          cd Projects/${{ github.event.repository.name }}
#          pip install lizard
#          ./run.sh complex
      - name: Upload artifacts
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: artifacts
          path: |
            ${{ github.event.repository.name }}/build/Doc/html
#            ${{ github.event.repository.name }}/build/TestCov/CodeCoverage
#            ${{ github.event.repository.name }}/build/codecloud.html
          retention-days: 1
  UploadToGHpages:
    name: UploadToGHpages
    if: success() && github.ref == 'refs/heads/main'   # Upload only from main
    needs: [Verification]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    permissions:
      contents: write  # Add to push to a branch
    steps:
      - name: Clone the repo
        run: |
          git clone --depth 1 --single-branch --branch gh-pages --no-tags https://github.com/${{ github.repository_owner }}/${{ github.event.repository.name }}.git
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: artifacts
          path: .
      - name: Upload
        run: |
          cd ${{ github.event.repository.name }}
          git config user.email "githubaction@users.noreply.github.com"
          git config user.name "GitHub Action"
          git config credential.username ${{ github.actor }}
          rm -rf Doc #CodeCoverage codecloud.html
          mv ../Doc/html Doc #mv ../TestCov/CodeCoverage CodeCoverage #mv ../codecloud.html codecloud.html
          git add Doc/ #CodeCoverage/ codecloud.html
          git commit --amend -m "Upload from ${{ github.sha }}" # Overwrite since the history is not needed for generated files
          git push --force https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository_owner }}/${{ github.event.repository.name }}.git